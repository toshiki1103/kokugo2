<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå†’é™ºãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ - èª­è§£åŠ›ã‚¯ã‚¨ã‚¹ãƒˆ</title>
    <link rel="stylesheet" href="stlye.css">
</head>
<body>

    <div id="game-container">
        <div id="setup-screen">
            <h1>ğŸ›¡ï¸ AIå†’é™ºãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ ğŸ›¡ï¸</h1>
            <p>å†’é™ºã‚’å§‹ã‚ã‚ˆã†</p>
            <br>
            <label>å­¦å¹´è¨­å®š: 
                <select id="grade-select" style="padding:5px; background:#333; color:white;">
                    <option value="å°å­¦1å¹´ç”Ÿ">å°å­¦1å¹´ç”Ÿ</option>
                    <option value="å°å­¦2å¹´ç”Ÿ" selected>å°å­¦2å¹´ç”Ÿ</option>
                    <option value="å°å­¦3å¹´ç”Ÿ">å°å­¦3å¹´ç”Ÿ</option>
                    <option value="é«˜å­¦å¹´">é«˜å­¦å¹´</option>
                </select>
            </label>
            <br><br>
            <button onclick="startGame()">å†’é™ºã«å‡ºç™ºã™ã‚‹ï¼</button>
        </div>

        <div id="game-screen" style="display:none;">
            <div class="status-bar">
                <span>Lv. <span id="level-display">1</span></span>
                <span>HP: <span id="hp-display" class="hp-val">100</span></span>
            </div>
            
            <div id="story-area">ã“ã“ã«ç‰©èªãŒè¡¨ç¤º</div>
            
            <div id="choices-area">
                </div>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ç®¡ç†
        let apiKey = "";
        let gameState = {
            grade: "å°å­¦3å¹´ç”Ÿ",
            hp: 100,
            level: 1,
            currentAnswer: "" // æ­£è§£ã‚’ä¸€æ™‚ä¿å­˜
        };

        // è¦ç´ ã®å–å¾—
        const storyArea = document.getElementById("story-area");
        const choicesArea = document.getElementById("choices-area");
        const hpDisplay = document.getElementById("hp-display");
        const levelDisplay = document.getElementById("level-display");

        // ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†
        function startGame() {
            const inputKey = "#"
            apiKey = inputKey;
            gameState.grade = document.getElementById("grade-select").value;

            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            const setupScreen = document.getElementById("setup-screen");
            const gameScreen = document.getElementById("game-screen");

            setupScreen.style.display = "none";
            gameScreen.style.display = "block";

            // æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆ
            generateEvent();
        }

        // AIã«ç‰©èªã‚’ç”Ÿæˆã•ã›ã‚‹é–¢æ•°
        async function generateEvent() { //fetchã§ã¯ãªãasnync/awaitã®æ–¹ãŒç¾ä»£çš„
            // UIã‚’ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã™ã‚‹
            storyArea.innerHTML = '<span class="loading">ç‰©èªã‚’ç”Ÿæˆä¸­...ï¼ˆã“ã®å…ˆã®çŸ³ç¢‘ã‚’è§£èª­ä¸­ï¼‰</span>';
            choicesArea.innerHTML = "";

            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆAIã¸ã®å‘½ä»¤æ›¸ï¼‰
            const systemPrompt = `
                ã‚ãªãŸã¯å­ä¾›å‘ã‘ã®RPGã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã§ã™ã€‚
                ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¯ã€Œ${gameState.grade}ã€ã®å­ä¾›ã§ã™ã€‚
                ä»¥ä¸‹ã®JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã¿ã§è¿”ç­”ã—ã¦ãã ã•ã„ã€‚ä½™è¨ˆãªä¼šè©±ã¯ä¸è¦ã§ã™ã€‚
                
                {
                    "story": "200æ–‡å­—ç¨‹åº¦ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã€‚ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã®æå†™ã‚„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã®å‡ºç¾ã€‚
                    å¿…ãšæœ€å¾Œã«ã€è¬ã€ã‚„ã€ã‚¯ã‚¤ã‚ºã€ã®çŠ¶æ³ã‚’å«ã‚ã‚‹ã“ã¨ã€‚å­ä¾›ãŒãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ã‚ˆã†ãªå•é¡Œã‚’ä½œã£ã¦ãã ã•ã„ã€‚
                    å›½èªã®æ–‡ç« é¡Œã®å•é¡Œã®ã‚ˆã†ã«ã€ã‚ˆãèª­ã¾ãªã„ã¨ç†è§£ã§ããªã„ã‚ˆã†ãªå•é¡Œã«ã—ã¦ãã ã•ã„ã€‚å°‘ã—é›£ã—ã„æ„Ÿã˜ã«ã¯ãµã‚ŠãŒãªã‚’æ‹¬å¼§æ›¸ãã§ã¤ã‘ã¦ä¸‹ã•ã„ã€‚",
                    "question": "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®å†…å®¹ã«é–¢ã™ã‚‹ã‚¯ã‚¤ã‚ºã®å•é¡Œæ–‡ã€‚",
                    "options": ["é¸æŠè‚¢1", "é¸æŠè‚¢2", "é¸æŠè‚¢3"],
                    "correct_option": "æ­£è§£ã®é¸æŠè‚¢ï¼ˆæ–‡å­—åˆ—ï¼‰",
                    "explanation": "æ­£è§£ã®è§£èª¬ã¨ã€è¤’ã‚ã‚‹è¨€è‘‰ã€‚"
                }
                
                ã‚¯ã‚¤ã‚ºã®ãƒ«ãƒ¼ãƒ«:
                - æ–‡è„ˆç†è§£ã‚’å•ã†å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
                - é›£æ˜“åº¦ã¯${gameState.grade}ã«åˆã‚ã›ã¦ãã ã•ã„ã€‚
            `;

            try {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini", // ã‚³ã‚¹ãƒˆåŠ¹ç‡ã®è‰¯ã„ãƒ¢ãƒ‡ãƒ«
                        response_format: { type: "json_object" }, // JSONãƒ¢ãƒ¼ãƒ‰
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: `ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«: ${gameState.level}ã€‚æ–°ã—ã„éƒ¨å±‹ã«å…¥ã‚Šã¾ã—ãŸã€‚è¬ã‚’å‡ºã—ã¦ãã ã•ã„ã€‚` }
                        ]
                    })
                });

                const data = await response.json();
                
                // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
                if (data.error) throw new Error(data.error.message);

                // AIã®è¿”ç­”(JSON)ã‚’ãƒ‘ãƒ¼ã‚¹
                const content = JSON.parse(data.choices[0].message.content);
                
                // ç”»é¢ã«åæ˜ 
                renderGame(content);

            } catch (error) {
                console.error(error);
                storyArea.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ " + error.message;
                //ãƒã‚¯ã‚¹ãƒˆã©ã†ã™ã¹ãã‹æç¤ºã§ãã¦ã„ãªã„
            }
        }

        // ç”»é¢æç”»é–¢æ•°
        function renderGame(content) {
            // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼
            storyArea.innerText = content.story + "\n\nã€å•é¡Œã€‘" + content.question;

            // æ­£è§£ã‚’ä¿å­˜
            gameState.currentAnswer = content.correct_option;

            // é¸æŠè‚¢ãƒœã‚¿ãƒ³ç”Ÿæˆ
            content.options.forEach(option => {
                const btn = document.createElement("button");
                btn.innerText = option;
                btn.onclick = () => checkAnswer(option, content);
                choicesArea.appendChild(btn);
            });
        }

        // ç­”ãˆåˆã‚ã›é–¢æ•°
        function checkAnswer(selected, content) {
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰
            const buttons = choicesArea.querySelectorAll("button");
            buttons.forEach(b => b.disabled = true);

            if (selected === content.correct_option) {
                // æ­£è§£ï¼
                storyArea.innerText += `\n\nâœ… æ­£è§£ï¼\n${content.explanation}`;
                gameState.level++;
                gameState.hp = Math.min(gameState.hp + 10, 100); // HPå›å¾©
                levelDisplay.innerText = gameState.level;
                hpDisplay.innerText = gameState.hp;
                
                // æ¬¡ã¸ãƒœã‚¿ãƒ³
                const nextBtn = document.createElement("button");
                nextBtn.innerText = "æ¬¡ã®éƒ¨å±‹ã¸é€²ã‚€ â¡";
                nextBtn.style.marginTop = "20px";
                nextBtn.style.borderColor = "#4CAF50";
                nextBtn.onclick = generateEvent;
                choicesArea.appendChild(nextBtn);

            } else {
                // ä¸æ­£è§£...
                gameState.hp -= 20;
                hpDisplay.innerText = gameState.hp;
                storyArea.innerText += `\n\nâŒ é–“é•ã„...\nãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼æ®‹ã‚ŠHP: ${gameState.hp}`;

                if (gameState.hp <= 0) {
                    alert("ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼... ã“ã“ã¾ã§ã®å†’é™ºã ã£ãŸã‚ˆã†ã ã€‚");
                    location.reload(); // æœ€åˆã«æˆ»ã‚‹
                } else {
                    // å†æŒ‘æˆ¦ãƒœã‚¿ãƒ³ã§ã¯ãªãã€æ¬¡ã¸é€²ã¾ã›ã‚‹ï¼ˆã¾ãŸã¯å†æŒ‘æˆ¦ã•ã›ã‚‹ï¼‰
                    const retryBtn = document.createElement("button");
                    retryBtn.innerText = "ãªã‚“ã¨ã‹é€ƒã’ã¦æ¬¡ã¸é€²ã‚€... â¡";
                    retryBtn.onclick = generateEvent;
                    choicesArea.appendChild(retryBtn);
                }
            }
        }
    </script>
</body>
</html>